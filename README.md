# ๐ค Proton Telegram Bot v2.0

Telegram ะฑะพั ะดะปั ะฟะปะฐััะพัะผั ะฐัะตะฝะดั ัะฟะตััะตัะฝะธะบะธ Proton ั ะฟะพะปะฝะพะน ะธะฝัะตะณัะฐัะธะตะน ั Laravel backend.

## ๐ ะัััััะน ััะฐัั

### 1. ะะฐัััะพะนะบะฐ ะพะบััะถะตะฝะธั

```bash
# ะะพะฟะธััะตะผ ะฟัะธะผะตั ะบะพะฝัะธะณััะฐัะธะธ
cp .env.example .env

# ะะตะดะฐะบัะธััะตะผ .env ัะฐะนะป
nano .env
```

ะะฑัะทะฐัะตะปัะฝัะต ะฟะตัะตะผะตะฝะฝัะต:
```env
BOT_TOKEN=your-telegram-bot-token
API_URL=https://app.protonrent.ru/api/v1
NOTIFY_SECRET=proton-telegram-secret-2024
LARAVEL_BEARER_TOKEN=your-laravel-api-token
```

### 2. ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน

```bash
# ะกะพะทะดะฐะฝะธะต ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั
python -m venv .venv

# ะะบัะธะฒะฐัะธั ะพะบััะถะตะฝะธั
source .venv/bin/activate  # Linux/Mac
# .venv\Scripts\activate   # Windows

# ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
pip install -r requirements.txt
```

### 3. ะะฐะฟััะบ ะฑะพัะฐ

```bash
# ะัะพััะพะน ะทะฐะฟััะบ
chmod +x start_bot.sh
./start_bot.sh

# ะะปะธ ะฒัััะฝัั
python -m uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

## ๐ API Endpoints

### ๐ ะัะฝะพะฒะฝัะต ัะฝะดะฟะพะธะฝัั

#### `GET /`
ะะฝัะพัะผะฐัะธั ะพ ะฑะพัะต ะธ ะดะพัััะฟะฝัั ัะฝะดะฟะพะธะฝัะฐั

#### `GET /health`
ะัะพะฒะตัะบะฐ ะทะดะพัะพะฒัั ัะตัะฒะธัะฐ
- ะะพะทะฒัะฐัะฐะตั ะธะฝัะพัะผะฐัะธั ะพ ะฑะพัะต ะธ ััะฐัััะต ะฟะพะดะบะปััะตะฝะธั

### ๐จ ะฃะฒะตะดะพะผะปะตะฝะธั

#### `POST /notify`
**ะัะฝะพะฒะฝะพะน ัะฝะดะฟะพะธะฝั ะดะปั ัะฒะตะดะพะผะปะตะฝะธะน ะพั Laravel**

**ะััะตะฝัะธัะธะบะฐัะธั:** Bearer token
```bash
Authorization: Bearer your-laravel-api-token
```

**ะกัััะบัััะฐ ะทะฐะฟัะพัะฐ:**
```json
{
  "telegram_id": "123456789",
  "order_data": {
    "order_id": "ORDER-123",
    "vehicle_type": "ะญะบัะบะฐะฒะฐัะพั",
    "location": "ะะพัะบะฒะฐ, ัะป. ะัะธะผะตัะฝะฐั, 1",
    "date_time": "15.01.2024 14:30",
    "price": "50 000 โฝ",
    "order_url": "https://app.protonrent.ru/orders/ORDER-123"
  }
}
```

**ะัะธะผะตัะฐะฝะธะต:** ะะพะปะต `order_url` ะพะฟัะธะพะฝะฐะปัะฝะพะต. ะัะปะธ ะฝะต ัะบะฐะทะฐะฝะพ, URL ะฑัะดะตั ััะพัะผะธัะพะฒะฐะฝ ะฐะฒัะพะผะฐัะธัะตัะบะธ ะบะฐะบ `https://app.protonrent.ru/orders/{order_id}`

**ะัะฒะตั:**
```json
{
  "success": true,
  "message": "Notification sent successfully",
  "data": {
    "telegram_id": "123456789",
    "order_id": "ORDER-123"
  }
}
```

#### `POST /notify-legacy`
**ะญะฝะดะฟะพะธะฝั ะดะปั ะพะฑัะฐัะฝะพะน ัะพะฒะผะตััะธะผะพััะธ**

**ะััะตะฝัะธัะธะบะฐัะธั:** X-API-Key
```bash
X-API-Key: proton-telegram-secret-2024
```

**ะกัััะบัััะฐ ะทะฐะฟัะพัะฐ:**
```json
{
  "telegram_id": "123456789",
  "text": "๐ ะะพะฒะฐั ะทะฐัะฒะบะฐ ะฝะฐ ะฐัะตะฝะดั ัะฟะตััะตัะฝะธะบะธ",
  "url": "https://app.protonrent.ru/orders/123"
}
```

## ๐ค ะะพะผะฐะฝะดั ะฑะพัะฐ

### `/start`
ะะตะณะธัััะฐัะธั ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ ัะธััะตะผะต
- ะะฐะฟัะฐัะธะฒะฐะตั ะฝะพะผะตั ัะตะปะตัะพะฝะฐ
- ะกะฒัะทัะฒะฐะตั Telegram ID ั ะฐะบะบะฐัะฝัะพะผ ะฒ Laravel

### `/stop`
ะัะฟะธัะบะฐ ะพั ัะฒะตะดะพะผะปะตะฝะธะน
- ะัะบะปััะฐะตั ัะฒะตะดะพะผะปะตะฝะธั ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปั
- ะัะทัะฒะฐะตั Laravel API ะดะปั ะพะฑะฝะพะฒะปะตะฝะธั ััะฐัััะฐ

### `/id`
ะะพะบะฐะทะฐัั Telegram ID ะฟะพะปัะทะพะฒะฐัะตะปั
- ะะพะปะตะทะฝะพ ะดะปั ะพัะปะฐะดะบะธ ะธ ะฝะฐัััะพะนะบะธ

## ๐ง ะะพะฝัะธะณััะฐัะธั

### ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั

| ะะตัะตะผะตะฝะฝะฐั | ะะฟะธัะฐะฝะธะต | ะะพ ัะผะพะปัะฐะฝะธั |
|------------|----------|--------------|
| `BOT_TOKEN` | ะขะพะบะตะฝ Telegram ะฑะพัะฐ | - |
| `API_URL` | URL Laravel API | `https://app.protonrent.ru/api/v1` |
| `LARAVEL_BEARER_TOKEN` | Bearer token ะดะปั Laravel | - |
| `NOTIFY_SECRET` | ะกะตะบัะตั ะดะปั legacy API | - |
| `WEBHOOK_SECRET` | ะกะตะบัะตั ะดะปั webhook | - |
| `BOT_HOST` | ะฅะพัั ะดะปั ะทะฐะฟััะบะฐ | `0.0.0.0` |
| `BOT_PORT` | ะะพัั ะดะปั ะทะฐะฟััะบะฐ | `8000` |
| `DEBUG` | ะะตะถะธะผ ะพัะปะฐะดะบะธ | `false` |
| `LOG_LEVEL` | ะฃัะพะฒะตะฝั ะปะพะณะธัะพะฒะฐะฝะธั | `INFO` |
| `LOG_FILE` | ะคะฐะนะป ะดะปั ะปะพะณะพะฒ | `bot.log` |

### Laravel ะบะพะฝัะธะณััะฐัะธั

ะ `.env` ัะฐะนะปะต Laravel ะดะพะฑะฐะฒััะต:
```env
TELEGRAM_BOT_API_URL=http://localhost:8000
TELEGRAM_BOT_API_TOKEN=your-api-token-here
TELEGRAM_NOTIFY_SECRET=proton-telegram-secret-2024
```

## ๐งช ะขะตััะธัะพะฒะฐะฝะธะต

### ะะฒัะพะผะฐัะธัะตัะบะพะต ัะตััะธัะพะฒะฐะฝะธะต
```bash
python test_integration.py
```

### ะััะฝะพะต ัะตััะธัะพะฒะฐะฝะธะต API

#### ะัะพะฒะตัะบะฐ ะทะดะพัะพะฒัั
```bash
curl http://localhost:8000/health
```

#### ะัะฟัะฐะฒะบะฐ ัะฒะตะดะพะผะปะตะฝะธั
```bash
curl -X POST http://localhost:8000/notify \
  -H "Authorization: Bearer your-api-token-here" \
  -H "Content-Type: application/json" \
  -d '{
    "telegram_id": "123456789",
    "order_data": {
      "order_id": "TEST-123",
      "vehicle_type": "ะญะบัะบะฐะฒะฐัะพั",
      "location": "ะะพัะบะฒะฐ",
      "date_time": "15.01.2024 14:30",
      "price": "50 000 โฝ",
      "order_url": "https://app.protonrent.ru/orders/TEST-123"
    }
  }'
```

#### Legacy ัะฒะตะดะพะผะปะตะฝะธะต
```bash
curl -X POST http://localhost:8000/notify-legacy \
  -H "X-API-Key: proton-telegram-secret-2024" \
  -H "Content-Type: application/json" \
  -d '{
    "telegram_id": "123456789",
    "text": "ะขะตััะพะฒะพะต ัะพะพะฑัะตะฝะธะต",
    "url": "https://example.com"
  }'
```

## ๐ ะะพะฝะธัะพัะธะฝะณ ะธ ะปะพะณะธัะพะฒะฐะฝะธะต

### ะะพะณะธ
- **ะคะฐะนะป ะปะพะณะพะฒ:** `bot.log`
- **ะะพะฝัะพะปัะฝัะต ะปะพะณะธ:** ะฒะบะปััะตะฝั ะฟะพ ัะผะพะปัะฐะฝะธั
- **ะฃัะพะฒะฝะธ:** DEBUG, INFO, WARNING, ERROR

### ะะพะฝะธัะพัะธะฝะณ
- **Health check:** `GET /health`
- **Swagger UI:** `http://localhost:8000/docs`
- **ReDoc:** `http://localhost:8000/redoc`

## ๐จ ะฃัััะฐะฝะตะฝะธะต ะฝะตะฟะพะปะฐะดะพะบ

### ะะพั ะฝะต ะทะฐะฟััะบะฐะตััั
1. ะัะพะฒะตัััะต `.env` ัะฐะนะป
2. ะฃะฑะตะดะธัะตัั, ััะพ ะฒัะต ะทะฐะฒะธัะธะผะพััะธ ัััะฐะฝะพะฒะปะตะฝั
3. ะัะพะฒะตัััะต ัะพะบะตะฝ ะฑะพัะฐ ะฒ @BotFather

### API ะฝะต ะพัะฒะตัะฐะตั
1. ะัะพะฒะตัััะต, ััะพ ะฑะพั ะทะฐะฟััะตะฝ ะฝะฐ ะฟัะฐะฒะธะปัะฝะพะผ ะฟะพััั
2. ะฃะฑะตะดะธัะตัั, ััะพ ัะพะบะตะฝั ะฐััะตะฝัะธัะธะบะฐัะธะธ ะบะพััะตะบัะฝั
3. ะัะพะฒะตัััะต ะปะพะณะธ ะฒ `bot.log`

### ะฃะฒะตะดะพะผะปะตะฝะธั ะฝะต ะดะพัะพะดัั
1. ะัะพะฒะตัััะต Telegram ID ะฟะพะปัะทะพะฒะฐัะตะปั
2. ะฃะฑะตะดะธัะตัั, ััะพ ะฟะพะปัะทะพะฒะฐัะตะปั ะฝะต ะทะฐะฑะปะพะบะธัะพะฒะฐะป ะฑะพัะฐ
3. ะัะพะฒะตัััะต ะปะพะณะธ ะพัะฟัะฐะฒะบะธ ัะพะพะฑัะตะฝะธะน

### ะัะธะฑะบะธ ะฐััะตะฝัะธัะธะบะฐัะธะธ
1. ะัะพะฒะตัััะต Bearer token ะฒ Laravel
2. ะฃะฑะตะดะธัะตัั, ััะพ X-API-Key ัะพะฒะฟะฐะดะฐะตั ะฒ ะพะฑะตะธั ัะธััะตะผะฐั
3. ะัะพะฒะตัััะต headers ะทะฐะฟัะพัะพะฒ

## ๐ ะะฝัะตะณัะฐัะธั ั Laravel

### ะัะฟะพะปัะทะพะฒะฐะฝะธะต TelegramBotIntegrationService

```php
use App\Services\TelegramBotIntegrationService;

// ะัะฟัะฐะฒะบะฐ ัะฒะตะดะพะผะปะตะฝะธั
$telegramService = new TelegramBotIntegrationService();
$success = $telegramService->sendNotification($telegramId, [
    'order_id' => $order->id,
    'vehicle_type' => $order->vehicleType->name,
    'location' => $order->getLocation(),
    'date_time' => $order->created_at->format('d.m.Y H:i'),
    'price' => number_format($order->total_price, 0, ',', ' ') . ' โฝ',
    'order_url' => config('app.url') . '/orders/' . $order->id
]);

// ะัะพะฒะตัะบะฐ ะทะดะพัะพะฒัั ะฑะพัะฐ
$health = $telegramService->checkBotHealth();
```

### ะะฑะฝะพะฒะปะตะฝะธะต ัััะตััะฒัััะธั ัะฒะตะดะพะผะปะตะฝะธะน

ะ `SendTelegramNotificationJob.php`:
```php
public function handle(TelegramBotIntegrationService $telegramService): void
{
    $orderData = [
        'order_id' => $this->order->id,
        'vehicle_type' => $this->order->vehicleType->name ?? 'ะะต ัะบะฐะทะฐะฝ',
        'location' => $this->getOrderLocation(),
        'date_time' => $this->order->created_at->format('d.m.Y H:i'),
        'price' => number_format($this->order->total_price ?? 0, 0, ',', ' ') . ' โฝ',
        'order_url' => config('app.url') . '/orders/' . $this->order->id
    ];

    $telegramService->sendNotification($this->user->telegram_id, $orderData);
}
```

## ๐๏ธ ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
โ   Laravel App   โ    โ  Telegram Bot    โ    โ  Telegram API   โ
โ                 โ    โ                  โ    โ                 โ
โ โโโโโโโโโโโโโโโ โ    โ โโโโโโโโโโโโโโโโ โ    โ                 โ
โ โTelegramBot  โโโโโโโโคโบโ FastAPI      โ โ    โ                 โ
โ โIntegration  โ โHTTPโ โ /notify      โ โ    โ                 โ
โ โService      โ โ    โ โ /health      โ โ    โ                 โ
โ โโโโโโโโโโโโโโโ โ    โ โโโโโโโโโโโโโโโโ โ    โ                 โ
โ                 โ    โ โโโโโโโโโโโโโโโโ โ    โ โโโโโโโโโโโโโโโ โ
โ โโโโโโโโโโโโโโโ โ    โ โ Aiogram      โโโโโโโโคโบโ Bot API     โ โ
โ โNotification โ โ    โ โ Handlers     โ โ    โ โ Webhook     โ โ
โ โJobs         โ โ    โ โ /start /stop โ โ    โ โโโโโโโโโโโโโโโ โ
โ โโโโโโโโโโโโโโโ โ    โ โโโโโโโโโโโโโโโโ โ    โ                 โ
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
```

## ๐ ะะพะดะดะตัะถะบะฐ

### ะะพะฝัะฐะบัั
- **ะะพะผะฐะฝะดะฐ ัะฐะทัะฐะฑะพัะบะธ:** Proton Development Team
- **ะะพะบัะผะตะฝัะฐัะธั:** [TELEGRAM_INTEGRATION.md](../ProtonBackend-GitLab/TELEGRAM_INTEGRATION.md)
- **ะขะตัะฝะธัะตัะบะพะต ะทะฐะดะฐะฝะธะต:** [TELEGRAM_BOT_FIX_SPECIFICATION.md](../ProtonBackend-GitLab/TELEGRAM_BOT_FIX_SPECIFICATION.md)

### ะะตััะธะธ
- **ะขะตะบััะฐั ะฒะตััะธั:** 2.0.0
- **ะกะพะฒะผะตััะธะผะพััั:** Laravel 10+, Python 3.8+, aiogram 3.4+

---

**๐ฏ ะกัะฐััั:** โ ะะพัะพะฒ ะบ production ะธัะฟะพะปัะทะพะฒะฐะฝะธั  
**๐ ะะฑะฝะพะฒะปะตะฝะพ:** ะกะตะฝััะฑัั 2025  
**๐ ะกะปะตะดัััะตะต ะพะฑะฝะพะฒะปะตะฝะธะต:** ะะพ ะผะตัะต ะฝะตะพะฑัะพะดะธะผะพััะธ